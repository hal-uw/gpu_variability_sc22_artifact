# Section 4D: SGEMM on AMD GPUs

## Application Overview and Directory Structure

Our application utilizes the SGEMM kerenl in AMD's hipBLAS library to perform matrix multiplication on two matrices containing single-precision floats. 

For compiling and launching SGEMM on AMD GPUs, please see sections [Pre-Requisites](#pre-requisites), [Build Container Image](#build-container-image), and [Run the Application](#run-the-application).

Below is a breakdown of this directory. 
```
├── sec4d_sgemm_amd
│   ├── gen_data.cpp: generates two input matrices of a size the user specifies
│   ├── gputimer.hip.h: 
│   ├── Makefile: make binaries for `gen_data.cpp` and `sgemm.cu`
│   ├── README.md: contains SGEMM specific instructions on running the application and configuring input size
│   ├── sgemm_rocblas.hip.cpp: main application that uses matrices generated from gen-data.cpp as inputs
│   ├── build-sgemm-amd.sh: builds sgemm application for AMD GPUs
│   ├── run-sgemm-amd.sh: runs sgemm application on AMD GPUs
```

## Adjusting Input Configurations

By default, `run-sgemm-amd.sh` performs 100 kernels of matrix multiplication on GPU 0 
with input matrices of size `24576x24576`. These parameters can be adjusted `run-sgemm-amd.sh`. Simply change the value after `NUM_KERN`, `DEVICE_ID` and/or `SIZE` in `run-sgemm-amd.sh`. 

## Pre-Requisites
* Machine with an AMD GPU
* Relevant GPU drivers installed
* Compilation and launch scripts assume a Vega 20 MI-60 GPU (`gfx906`).
* If your GPU is not an MI-60, edit `amdgpu-target` on line 7 of `Makefile` with the following targets, as applicable: 


| Graphics Architecture   |	GPU Codename          | Product              |      `amdgpu-target` flag     | 
|:------------------------|:----------------------|:---------------------|:-------------------|
| GCN 5.0 | VEGA 10 | RX VEGA / Radeon Pro | GFX900 |
| GCN 5.0 | RAVEN        | Ryzen 2000/3000(G/GE)     | GFX902 |
| GCN 5.0 | VEGA 12   | Vega Pro 20 (MAC)          | GFX904 |
| GCN 5.0 | VEGA 20    | Radeon VII / Radeon Pro VII, MI-50 / 60 | GFX906 |
| CDNA 1  | ARCTURUS   | Instinct MI100 TBC         | GFX908 |
| CDNA 2  | TBC | MI200 | GFX90A
| GCN 5.0 | RAVEN2 	   | TBC                     | GFX909 |
| GCN 5.0 | RENOIR 	   | Ryzen 4000(H/U/G)          | GFX909 |
| RDNA 1  | NAVI 10    | RX 5700/5600(M/XT)         | GFX1010|
| RDNA 1  | NAVI 12    | PRO 5600M (MAC)            | GFX1011|
| RDNA 1  | NAVI 14    | RX 5500 (M/XT)             | GFX1012|
| RDNA 2  | NAVI 21    | RX 6900(XT) TBC            | GFX1030|
| RDNA 2  | NAVI 22    | PRO 6600M (MAC) TBC        | GFX1031|
| RDNA 2  | NAVI 23    | RX 6500 (M/XT) TBC         | GFX1032|
| RDNA 2  | VAN GOGH   | Ryzen 5000G TBC            | GFX1033|
| RDNA 2  | VAN GOGH LITE    | TBC                   | GFX1040|            

## Build Container Image
Note that to successfully build this docker image and the necessary libraries/packages used for SGEMM, you will
need sudo access on the machine you are doing this work. Otherwise, the container image will fail to build.
```
# Build container image
docker build -t sgemm_amd_image .
```

## Run the application
There will be 1 csv file and 1 txt file output generated by the profiler (rocprof/rocm-smi), which contains kernel information, GPU SM frequency, power, and temperature. These files will be stored in the docker container by default. To access these files, you will have to copy them using `docker cp` (shown below) to the directory of your choice (we recommend `../out/`).

```
# Run application
docker run --gpus all sgemm_amd_image

# Move data from container to local storage
docker create -ti --name dummy0 sgemm_amd_image bash
<Returns Container ID c_id>
docker cp <c_id>:/sec4d/*.csv ../out/.
docker cp <c_id>:/sec4d/*.txt ../out/.
docker rm -f dummy0
```

## Build and Run Without Docker

There are four steps to build and run SGEMM on NVIDIA GPUs:
```
chmod u+x ./build-sgemm-amd.sh
chmod u+x ./run-sgemm-amd.sh
./build-sgemm-amd.sh
./run-sgemm-amd.sh
```
You will find two output files in `../out`. One will be `../out/sgemm-amd-*.csv` and the other will be `../out/sgemm-amd-*.txt`. The `.csv` file contains kernel runtime information and the `.txt` file contains GPU SM frequency, power, and temperature measurements over the duration of the application run.