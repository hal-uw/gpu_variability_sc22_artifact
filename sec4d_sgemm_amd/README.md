# Section 4D: SGEMM on AMD GPUs

## Application Overview and Directory Structure

Our application utilizes the SGEMM kernel in AMD's rocBLAS library to perform matrix multiplication on two matrices containing single-precision floats. 

For compiling and launching SGEMM on AMD GPUs, please see sections [Prerequisites](#prerequisites), [Pull Container Image and Run the Application](#pull-container-image-and-run-the-application).

Below is a breakdown of this directory. 
```
├── gen_data.cpp: generates two input matrices of a size the user specifies
├── gputimer.hip.h: header file to create manual timer for CUDA calls
├── Makefile: make binaries for `gen_data.cpp` and `sgemm.cu`
├── README.md: contains SGEMM specific instructions on running the application and configuring input size
├── sgemm_rocblas.hip.cpp: main application that uses matrices generated from gen-data.cpp as inputs
├── build-sgemm-amd.sh: script used by the Dockerfile to build sgemm (can be used to run without docker)
├── run-sgemm-amd.sh: script used by the Dockerfile to run sgemm (can be used to run without docker)
├── sgemm-singularity.sh: Top-level script that pulls a container image, compiles SGEMM binary and related packages, and runs SGEMM on AMD GPUs
```

## Adjusting Input Configurations

By default, `run-sgemm-amd.sh` performs 100 kernels of matrix multiplication on GPU 0 
with input matrices of size `24576x24576`. These parameters can be adjusted `run-sgemm-amd.sh`. Simply change the value after `NUM_KERN`, `DEVICE_ID` and/or `SIZE` in `run-sgemm-amd.sh`. 

## Prerequisites
* Machine with an AMD GPU
* Relevant GPU drivers installed
* Compilation and launch scripts assume one or more Vega 20 MI60 GPUs (`gfx906`) are available on the compute node. The scripts work with any AMD GPU however.
* If your GPU is not an MI60, edit `amdgpu-target` on line 7 of `Makefile` with the following targets, as applicable: 


| Graphics Architecture   |	GPU Codename          | Product              |      `amdgpu-target` flag     | 
|:------------------------|:----------------------|:---------------------|:-------------------|
| GCN 5.0 | VEGA 10 | RX VEGA / Radeon Pro | GFX900 |
| GCN 5.0 | RAVEN        | Ryzen 2000/3000(G/GE)     | GFX902 |
| GCN 5.0 | VEGA 12   | Vega Pro 20 (MAC)          | GFX904 |
| GCN 5.0 | VEGA 20    | Radeon VII / Radeon Pro VII, MI50 / 60 | GFX906 |
| CDNA 1  | ARCTURUS   | Instinct MI100 TBC         | GFX908 |
| CDNA 2  |            | MI200 | GFX90A
| GCN 5.0 | RAVEN2 	   | TBC                     | GFX909 |
| GCN 5.0 | RENOIR 	   | Ryzen 4000(H/U/G)          | GFX909 |
| RDNA 1  | NAVI 10    | RX 5700/5600(M/XT)         | GFX1010|
| RDNA 1  | NAVI 12    | PRO 5600M (MAC)            | GFX1011|
| RDNA 1  | NAVI 14    | RX 5500 (M/XT)             | GFX1012|
| RDNA 2  | NAVI 21    | RX 6900(XT) TBC            | GFX1030|
| RDNA 2  | NAVI 22    | PRO 6600M (MAC) TBC        | GFX1031|
| RDNA 2  | NAVI 23    | RX 6500 (M/XT) TBC         | GFX1032|
| RDNA 2  | VAN GOGH   | Ryzen 5000G TBC            | GFX1033|
| RDNA 2  | VAN GOGH LITE    | TBC                   | GFX1040|            

## Pull Container Image and Run the Application
We use an existing Docker image from the Docker registry, pulled using Singularity. Steps to build and run SGEMM on AMD GPUs using a Singularity container:

(1) Ensure that Singularity is installed/loaded on the compute node. Compute nodes on most HPC clusters have singularity pre-installed as a module, which needs to be loaded using cluster-specific commands. For instance, on any Texas Advanced Computing Center (TACC) cluster, `module load tacc-singularity` loads the latest stable version of Singularity. 
Note that these steps and scripts are tested with Singularity v3.7.2-4.el7a. 

(2) Run the top-level script `sgemm-singularity.sh`. This script pulls the relevant container and runs all compilation and application execution steps to return output. 
```
./sgemm-singularity.sh
```

There will be 1 csv file and 1 txt file output generated by the profiler (rocprof/rocm-smi), which contains kernel information, GPU SM frequency, power, and temperature. These files will be stored in the current working directory. 

## Build and Run Without Container

If the machine has AMD GPU drivers, `rocprof/rocm-smi`, `rocm-dev` and `rocblas` libraries installed, SGEMM can be run without a container. There are four steps to build and run SGEMM without a container on AMD GPUs:
```
chmod u+x ./build-sgemm-amd.sh
chmod u+x ./run-sgemm-amd.sh
./build-sgemm-amd.sh
./run-sgemm-amd.sh
```
You will find the output csv and txt files from the `rocprof/rocm-smi` profiler directly in this directory. 
